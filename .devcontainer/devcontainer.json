{
  "name": "Gfr√∂rli API Devcontainer",

  "build": {
    "dockerfile": "Dockerfile"
  },

  // Container runtime options
  "runArgs": [
    // Basic security: Limited capabilities
    "--cap-drop=ALL",
    "--cap-add=CHOWN",
    "--cap-add=SETGID"
  ],

  // Run as non-root user
  "remoteUser": "dev",

  // Automatically update container user UID/GID to match host user
  "updateRemoteUserUID": true,

  // Set working directory (devcontainer mounts workspace here)
  "workspaceMount": "source=${localWorkspaceFolder},target=/code,type=bind,consistency=cached",
  "workspaceFolder": "/code",

  // Commands run after creating devcontainer
  "initializeCommand": {
    "create-opencode-config-dir": "mkdir -p ${HOME}/.config/opencode",
    "create-opencode-auth-file": "mkdir -p ${HOME}/.local/share/opencode && touch ${HOME}/.local/share/opencode/auth.json"
  },

  // Mounts
  "mounts": [
    // OpenCode config (shared across projects)
    "source=${localEnv:HOME}/.config/opencode,target=/home/dev/.config/opencode,type=bind,consistency=cached",
    // OpenCode data storage (project-specific named volume for sessions, messages, etc.)
    "source=devcontainer--${localWorkspaceFolderBasename}--opencode-data,target=/home/dev/.local/share/opencode,type=volume",
    // OpenCode credentials (shared from host, overlays on top of the volume)
    "source=${localEnv:HOME}/.local/share/opencode/auth.json,target=/home/dev/.local/share/opencode/auth.json,type=bind,consistency=cached"
  ],

  // Features to install
  "features": {
    "./features/postgresql": {
      "version": "16"
    },
    "./features/opencode": {
      "version": "latest",
      "binaryType": "glibc"
    }
  },

  // Forward ports
  "forwardPorts": [3000, 5432],
  "otherPortsAttributes": {
    "onAutoForward": "ignore"
  },

  // Container environment variables
  "containerEnv": {
    "RAILS_ENV": "development"
  },

  // After first start
  "postStartCommand": "pg-start.sh && bin/setup --skip-server && bin/dev -d",

  // Customizations
  "customizations": {
    "vscode": {
      "settings": {
        // General
        "editor.formatOnSave": true,
        "files.insertFinalNewline": true,
        // JSON
        "[jsonc]": {
          "editor.defaultFormatter": "esbenp.prettier-vscode",
          "json.format.keepLines": true
        },
        // Ruby
        "[ruby]": {
          "editor.defaultFormatter": "Shopify.ruby-lsp"
        }
      },
      "extensions": [
        // General
        "dnut.rewrap-revived",
        "esbenp.prettier-vscode",
        // Ruby
        "Shopify.ruby-lsp",
        // PostgreSQL
        "ms-ossdata.vscode-pgsql"
      ]
    }
  }
}
